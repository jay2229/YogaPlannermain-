<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile | Yoga Planner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #1e40af;
      --primary-dark: #1e3a8a;
      --secondary-color: #3b82f6;
      --surface-color: #ffffff;
      --background-color: #f8fafc;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
    }

    body { font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, var(--background-color) 0%, #e0f2fe 100%); margin: 0; padding: 0; color: var(--text-primary);}    

   /* === Updated Sidebar Styling === */
    .sidebar-yoga {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100vh;
      background: linear-gradient(180deg, #4a6fa5 0%, #2d4a73 100%);
      color: white;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      padding: 30px 0;
      box-shadow: 4px 0 12px rgba(0,0,0,0.15);
      transition: transform 0.3s ease;
    }
    
    .sidebar-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 0 20px;
    }
    
    .profile-img {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 4px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      font-weight: bold;
    }
    
    .profile-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      color: white;
    }

    .sidebar-yoga nav {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-yoga nav a {
      display: flex;
      align-items: center;
      gap: 20px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-weight: 500;
      font-size: 1rem;
      padding: 18px 30px;
      transition: all 0.3s ease;
      border-radius: 0;
      position: relative;
    }

    .sidebar-yoga nav a:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      transform: translateX(5px);
    }
    
    .sidebar-yoga nav a.active {
      background: rgba(255,255,255,0.15);
      color: white;
      border-left: 4px solid #64b5f6;
      font-weight: 600;
    }
    
    .sidebar-yoga nav a i {
      font-size: 1.3rem;
      width: 24px;
      text-align: center;
    }

    /* Main content container to prevent overlap */
    .main-content-container {
      margin-left: 260px; /* Same as sidebar width */
      transition: margin-left 0.3s ease;
      min-height: 100vh;
      padding: 40px;
    }
    
    .container { 
      max-width: 520px; 
      margin: 0 auto;
      background: #fff; 
      box-shadow: 0 4px 20px rgba(50,50,93,0.15); 
      border-radius: 16px; 
      padding: 40px 35px; 
      text-align: center;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    h2 { 
      color: #2b5876; 
      margin-bottom: 24px; 
      font-weight: 700;
      font-size: 1.8rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1rem;
      font-weight: 400;
    }
    
    form { 
      display: flex; 
      flex-direction: column; 
      gap: 20px;
    }

    .form-section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 16px;
      text-align: left;
      border: 1px solid #e2e8f0;
      transition: transform 0.2s ease;
    }

    .form-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2b5876;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .info {
      text-align: left;
      margin-bottom: 30px;
    }

    .info p {
      margin: 8px 0;
      font-size: 1rem;
    }

    .info .label {
      font-weight: 600;
      color: #2b5876;
      margin-bottom: 4px;
    }

    label {
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }
    
    input, select, textarea { 
      padding: 12px 14px; 
      border-radius: 8px; 
      border: 2px solid #e2e8f0; 
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    button { 
      background: linear-gradient(120deg,#2b5876 0%,#4e4376 100%); 
      color: #fff; 
      border: none; 
      border-radius: 10px; 
      padding: 14px 0; 
      font-size: 1.1em; 
      font-weight: 700; 
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 16px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(43, 88, 118, 0.3);
    }

    button:active {
      transform: translateY(0);
    }
    
    .error { 
      color: #dc3545; 
      margin-top: 12px;
      padding: 12px;
      background: #f8d7da;
      border-radius: 8px;
      border: 1px solid #f5c6cb;
      font-size: 0.9rem;
    }
    
    .success { 
      color: #155724; 
      margin-top: 12px;
      padding: 12px;
      background: #d4edda;
      border-radius: 8px;
      border: 1px solid #c3e6cb;
      font-size: 0.9rem;
    }
    
    .btn-secondary { 
      background: linear-gradient(120deg,#4e4376 0%,#2b5876 100%);
      margin-top: 12px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .sidebar-yoga {
        transform: translateX(-100%);
        width: 100%;
        padding-top: 20px;
      }
      .main-content-container {
        margin-left: 0;
      }
      .container {
        margin-left: auto;
        margin-right: auto;
        max-width: 90%;
        padding: 30px 20px;
      }
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <aside class="sidebar-yoga">
    <div class="sidebar-header">
      <div class="profile-img">Profile Image</div>
      <h3 class="profile-name">Yoga User</h3>
    </div>
    <nav>
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
      <a href="input.html"><i class="fas fa-user-edit"></i> Input Details</a>
      <a href="profile.html" class="active"><i class="fas fa-user"></i> Profile</a>
      <a href="plan.html"><i class="fas fa-calendar-alt"></i> Yoga Plan</a>
      <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
      <a href="login.html"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
    </nav>
  </aside>

  <div class="main-content-container">
    <div class="container">
      <h2>Your Profile</h2>
      <div class="info">
        <p class="label">Email:</p>
        <p><span id="profileEmail"></span></p>
        <p class="label">Name:</p>
        <p><span id="profileName"></span></p>
        <p class="label">Password:</p>
        <p><span id="profilePassword"></span></p>
      </div>
      <form id="changeUsernameForm">
        <div class="form-group">
          <label for="newUsername" class="label">Change Username:</label>
          <input type="text" id="newUsername" placeholder="Enter new username">
        </div>
        <button type="submit" class="btn">Update Username</button>
      </form>
      <form id="setNamesForm">
        <div class="form-group">
          <label for="firstNameInput" class="label">First Name:</label>
          <input type="text" id="firstNameInput" placeholder="Enter first name">
        </div>
        <div class="form-group">
          <label for="lastNameInput" class="label">Last Name:</label>
          <input type="text" id="lastNameInput" placeholder="Enter last name">
        </div>
        <button type="submit" class="btn">Save Name</button>
      </form>
      <button id="logoutBtn">Logout</button>
      <div class="error" id="error"></div>
      <div class="success" id="success"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

     const firebaseConfig = {
      apiKey: "AIzaSyB4NhiLKoiPMSZwvj2ouBjyHHe20WVQjng",
      authDomain: "csproject-a332d.firebaseapp.com",
      projectId: "csproject-a332d",
      storageBucket: "csproject-a332d.appspot.com",
      messagingSenderId: "155004934642",
      appId: "1:155004934642:web:30a34be7ed0e321769736b",
      measurementId: "G-PN46OMWXZV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // This listener now correctly handles redirection logic
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Redirect to login page if user is not authenticated
        window.location.href = "login.html";
      } else {
        // User is authenticated, proceed to load and display their profile info
        const emailSpan = document.getElementById('profileEmail');
        const nameSpan = document.getElementById('profileName');
        const passwordSpan = document.getElementById('profilePassword');
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');

        emailSpan.textContent = user.email;
        nameSpan.textContent = user.displayName || "(not set)";
        passwordSpan.textContent = "********";
        
        try {
          const userDocRef = doc(db, "users", user.uid);
          const userDocSnap = await getDoc(userDocRef);
          if (userDocSnap.exists()) {
            const data = userDocSnap.data();
            if (data.firstName) nameSpan.textContent = data.firstName;
            else if (data.name) nameSpan.textContent = data.name;
          }
        } catch (err) {
          errorDiv.textContent = "Error loading profile: " + err.message;
        }
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      const changeUsernameForm = document.getElementById('changeUsernameForm');
      const newUsernameInput = document.getElementById('newUsername');
      const setNamesForm = document.getElementById('setNamesForm');
      const firstNameInput = document.getElementById('firstNameInput');
      const lastNameInput = document.getElementById('lastNameInput');
      const errorDiv = document.getElementById('error');
      const successDiv = document.getElementById('success');

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await signOut(auth);
          } catch (err) {
            errorDiv.textContent = "Logout failed: " + err.message;
          }
        });
      }

      if (changeUsernameForm) {
        changeUsernameForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          errorDiv.textContent = "";
          successDiv.textContent = "";
          const newUsername = newUsernameInput.value.trim();
          if (!newUsername) {
            errorDiv.textContent = "Username cannot be empty.";
            return;
          }
          const user = auth.currentUser;
          if (!user) {
            errorDiv.textContent = "User not authenticated.";
            return;
          }
          try {
            await updateProfile(user, { displayName: newUsername });
            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, { name: newUsername }, { merge: true });
            document.getElementById('profileName').textContent = newUsername;
            successDiv.textContent = "Username updated successfully!";
            newUsernameInput.value = "";
          } catch (err) {
            errorDiv.textContent = "Failed to update username: " + err.message;
          }
        });
      }

      if (setNamesForm) {
        setNamesForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          errorDiv.textContent = "";
          successDiv.textContent = "";
          const firstName = firstNameInput.value.trim();
          const lastName = lastNameInput.value.trim();
          const user = auth.currentUser;
          if (!user) {
            errorDiv.textContent = "User not authenticated.";
            return;
          }
          if (!firstName) {
            errorDiv.textContent = "First name is required.";
            return;
          }
          try {
            await updateProfile(user, { displayName: firstName });
            const userDocRef = doc(db, "users", user.uid);
            await setDoc(userDocRef, { firstName, lastName, name: firstName }, { merge: true });
            document.getElementById('profileName').textContent = firstName;
            successDiv.textContent = "Name saved successfully!";
          } catch (err) {
            errorDiv.textContent = "Failed to save name: " + err.message;
          }
        });
      }

      document.querySelectorAll('.sidebar-yoga nav a').forEach(link => {
        if (window.location.pathname.includes(link.getAttribute('href'))) {
          link.classList.add('active');
        }
      });
    });
  </script>
</body>
</html>